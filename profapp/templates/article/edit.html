{% extends "index_lazy_layout.html" %}

{% block head %}
    {{ super() }}
    {% include '_ruslan/partials/_header_files_articles.html' %}
    {% include '_ruslan/partials/_header_files_crop.html' %}
{% endblock head %}

{% block portal_content %}

    {% block company_base %}
        {% include 'company/company_base_angular.html' %}
    {% endblock company_base %}

    <script>
        module.controller('article_edit', ['$scope', '$ok', '$http', function ($scope, $ok, $http) {

            angularControllerFunction('CompanyMenuController', 'set_selected_company_menu')('materials');

            $scope.$$translate = {{ translates('article_edit')|safe }};
            $scope.data = {};

            $scope.title = '{{ 'Update material' if material_id else 'Create new material' }}';

            $scope.amidSave = function (resp) {
                if (!$scope.data.material.id && resp.material.id) {
                    window.location.href = {{ raw_url_for('article.edit_material')|safe }}({
                        company_id: resp.material.company_id,
                        material_id: resp.material.id
                    })
                }
                else {
                    $scope.data['material']['illustration'] = resp['material']['illustration'];
                    add_message($scope._('material was saved'), 'success', 3000);
                    window.location.href = {{ raw_url_for('article.material_details')|safe}}({
                        company_id: resp.material.company_id,
                        material_id: resp.material.id
                    })
                }
            };

            $scope.goToArticle = function (material) {
                var url = {{ raw_url_for('article.material_details')|safe }}({
                    company_id: material.company_id,
                    material_id: material.id
                });
                var win = window.open(url, '_blank');
                win.focus();
            };

            $scope.getData = function (model, deff) {
                return deff(model);
            };

            $scope.getDataForValidation = function (model, deff) {
                var ret = $.extend(true, {}, model);
                delete ret['material']['image_galleries'];
                delete ret['material']['illustration'];
                delete ret['material']['long'];
                return deff(ret);
            };

            $scope.amidLoad = function (resp) {
                if (typeof resp === 'string') {
                    location.href = '/';
                    add_message(resp, 'warning', 2000);
                }
                $.each(resp['material']['image_galleries'], function (ind, gal) {
                    $.each(gal['items'], function (ind1, item) {
                        item['background_image'] = 'url(' + fileUrl(item['file_id']) + ')';
                    });
                });
                return resp;
            };
            $scope.tinyArticleOptions = $.extend(true, $scope.tinymceDefaultOptions);

            {% if publication_id %}
                var custom_formats = {{ tinymce_format_groups('birdy')|tojson }};
                tinymceExtendSettings($scope.tinyArticleOptions, 'foreground | background | font | border | margin | padding', 'toolbar2', ' | ');
            {% else %}
                var custom_formats = {};
            {% endif %}

            var formats =
                _.chain($.extend({}, {{ tinymce_format_groups()|tojson }}, custom_formats)).// here we have dict in form {group_label: {format: format_properties}}
                reduce(_.extend, {}).// flatten groups
                map(function (format_properties, format_name) { // convert each format to tinymce in flat dictionary
                    return [format_name, convert_python_format_to_tinymce_format(format_properties)]; // form list of [key, val] pairs
                }).object().// convert each [key, val] pair to {key: val} element
                value(); // get result

            tinymceExtendSettings($scope.tinyArticleOptions, {
                'height': '500px',
                'body_class': 'article-content',
                'gallery_get_data': function (gallery_id) {
                    return find_by_id($scope.data['material']['image_galleries'], gallery_id);
                },
                'gallery_set_data': function (gallery_id, data) {
                    var index = find_index_by_id($scope.data['material']['image_galleries'], gallery_id);
                    if (index>-1) {
                        $scope.data['material']['image_galleries'][index] = data;
                    }
                    else {
                        $scope.data['material']['image_galleries'].push(data);
                    }
                }, 'formats': formats,
                'pr_formats': _.size(custom_formats) ? get_array_for_menu_build(custom_formats) : [],
            });

            tinymceExtendSettings($scope.tinyArticleOptions, 'gallery', 'plugins', ' ');
            tinymceExtendSettings($scope.tinyArticleOptions, 'gallery', 'toolbar1', ' ');
            tinymceExtendSettings($scope.tinyArticleOptions, ['{{ static_address('tinymce.pr/plugins/tinymce-gallery-plugin/image_gallery.css') }}'], 'content_css');
        }]);
    </script>

    {% raw %}
    <div ng-init="init()" ng-controller="article_edit" ng-cloak class="create-material">
        <div class="row link-page create-new-material"><h5>{{ _(title) }}</h5></div>
        <form name="newMaterial">
            <!-- <h1 class="nice-title">{{ _(title) }}<span></span></h1> -->

            <div af af-amid-load="amidLoad" af-amid-save="amidSave"
                 af-before-save="getData"
                 af-before-validate="getDataForValidation"
                 af-watch="[data.material.short, data.material.title, data.material.subtitle, data.material.keywords, data.material.keywords]" ng-model="data">

                <div style="padding-bottom: 50px">
                    <div>
                        <div style="width: 400px; height: 300px; position: relative"
                             pr-crop="data.material.illustration"></div>
                    </div>
                </div>

                <div class="update_col1">
                    <!-- TODO: OK by OZ:   this block form should share same classes with layout to look MAXIMUM like in portal
                                            maybe layout selector is apporpriate here-->
                    {{ _('Article title') }}
                    <pr_help_tooltip>article_title</pr_help_tooltip>
                    <input class="form-control article-edit-input" type="text" ng-model="data.material.title"
                           pr-validation-answer="data_validation:title"
                           name="article_title" jng-pattern="/[\wа-яёі']{3}/i">
                    <div ng-show="newMaterial.article_title.$error.pattern" class="error-input">
                        {{ _('The title name should be longer!') }}
                    </div>

                    {{ _('Article subtitle') }}
                    <pr_help_tooltip>article_subtitle</pr_help_tooltip>
                    <span
                            af-validation-answer="data_validation:subtitle"></span>
                    <input class="form-control article-edit-input" type="text" ng-model="data.material.subtitle">

                    {{ _('Keywords') }}
                    <input class="form-control article-edit-input" ng-model="data.material.keywords"
                           pr-validation-answer="data_validation:keywords"
                           name="article_keywords" jng-pattern="/[\wа-яёі']{2}/i">
                    <div ng-show="newMaterial.article_keywords.$error.pattern" class="error-input">
                        {{ _('The keywords should be longer!') }}
                    </div>

                    {{ _('Author') }}
                    <pr_help_tooltip>article_author</pr_help_tooltip>
                    <input class="form-control article-edit-input" ng-model="data.material.author"
                           pr-validation-answer="data_validation:author"
                           name="article_author" jng-pattern="/[\wа-яёі']{2}/i">
                    <div ng-show="newMaterial.article_author.$error.pattern" class="error-input">
                        {{ _('The author should be longer!') }}
                    </div>
                </div>


                <div class="update_col1">
                    <!-- TODO: OZ by OZ move this code to one file -->
                    {% endraw %}
                    <link href="{{ static_address('css/article.css') }}" rel="stylesheet">
                    <!-- TODO: OZ by OZ: select css for current theme. also look for another place with same todo-->
                    {% raw %}

                    {{ _('Short Description') }} <span af-validation-answer="data_validation:short"></span>
                    <textarea class="form-control article-edit-input" style="width: 710px" placeholder="{{_('short')}}"
                              ng-model="data.material.short"></textarea>

                    {{ _('Full text') }}
                    <textarea ui-tinymce="tinyArticleOptions" id="article_editor"
                              ng-model="data.material.long"></textarea>
                </div>


                <div class="update_col1">
                    *{{ _('All fields are required') }}

                    <button class="pr-button" ng-disabled="!$af.isActionAllowed(data, 'save')"
                            ng-click="$af.save(data)">&nbsp;<span class="glyphicon glyphicon-save-file"></span>&nbsp;{{
                        data.material.id ? _('save') : _('create') }}
                    </button>
                    <button class="pr-button" ng-click="goToArticle(data.article)" ng-if="article_type"><span class="fa
                    fa-external-link">{{ _(article_type +
                        ' preview') }}</span></button>
                </div>
            </div>
        </form>
    </div>
    {% endraw %}

{% endblock %}


